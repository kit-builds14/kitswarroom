<!DOCTYPE html>
<html lang="en">
<head><script src="../auth.js"></script><link rel="stylesheet" href="../responsive.css">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dyer Auto Group - L10 Meeting Runner</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--navy:#1a2744;--navy-light:#243356;--gold:#c9a84c;--gold-light:#e0c36a;--bg:#0f1a2e;--card:#1e2d4a;--text:#e8e8e8;--text-dim:#8899b0;--green:#2ecc71;--red:#e74c3c;--orange:#f39c12}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
button{cursor:pointer;font-family:inherit;border:none;border-radius:4px;padding:6px 14px;font-size:14px;transition:all .15s}
input,select,textarea{font-family:inherit;background:var(--navy);color:var(--text);border:1px solid #3a4a6a;border-radius:4px;padding:6px 10px;font-size:14px}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--gold)}
.btn{background:var(--gold);color:var(--navy);font-weight:600}
.btn:hover{background:var(--gold-light)}
.btn-sm{padding:4px 10px;font-size:12px}
.btn-danger{background:var(--red);color:#fff}
.btn-secondary{background:#3a4a6a;color:var(--text)}
.btn-secondary:hover{background:#4a5a7a}
.btn-green{background:var(--green);color:#fff}

/* Layout */
#app{max-width:1100px;margin:0 auto;padding:10px}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--navy);border-radius:8px;margin-bottom:10px;flex-wrap:wrap;gap:8px}
header h1{font-size:18px;color:var(--gold);white-space:nowrap}
.header-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

/* Timer */
.timer-bar{background:var(--navy);border-radius:8px;padding:12px 20px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10}
.timer-display{font-size:42px;font-weight:700;font-variant-numeric:tabular-nums;letter-spacing:2px}
.timer-display.warning{color:var(--orange)}
.timer-display.expired{color:var(--red);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.timer-section-name{font-size:16px;color:var(--gold);font-weight:600}
.timer-controls{display:flex;gap:6px}

/* Sections nav */
.sections-nav{display:flex;gap:4px;margin-bottom:10px;overflow-x:auto;padding-bottom:4px}
.sections-nav button{background:var(--navy);color:var(--text-dim);padding:8px 14px;font-size:13px;white-space:nowrap;border-radius:6px}
.sections-nav button.active{background:var(--gold);color:var(--navy);font-weight:700}
.sections-nav button.completed{border-bottom:3px solid var(--green)}

/* Cards */
.section-card{background:var(--card);border-radius:8px;padding:16px;margin-bottom:10px;display:none}
.section-card.active{display:block}
.section-card h2{font-size:16px;color:var(--gold);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.section-card h2 span.time-alloc{font-size:12px;color:var(--text-dim);font-weight:400}

/* Tables */
table{width:100%;border-collapse:collapse;font-size:14px}
th{text-align:left;padding:6px 8px;border-bottom:2px solid var(--navy);color:var(--gold);font-size:12px;text-transform:uppercase}
td{padding:6px 8px;border-bottom:1px solid #2a3a5a}
tr:hover{background:rgba(201,168,76,.05)}

/* Toggle */
.toggle{display:inline-flex;gap:0;border-radius:4px;overflow:hidden}
.toggle button{border-radius:0;padding:4px 10px;font-size:12px;background:#3a4a6a;color:var(--text-dim)}
.toggle button.on{background:var(--green);color:#fff}
.toggle button.off{background:var(--red);color:#fff}

/* Inline add */
.add-row{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.add-row input,.add-row select{flex:1;min-width:120px}

/* Attendees */
.attendees-grid{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
.attendee-chip{background:var(--navy);padding:4px 10px;border-radius:20px;font-size:13px;display:flex;align-items:center;gap:6px}
.attendee-chip .remove{cursor:pointer;color:var(--red);font-weight:700}

/* Rating */
.rating-row{display:flex;align-items:center;gap:10px;padding:4px 0}
.rating-row input[type=range]{flex:1;max-width:200px}
.rating-avg{font-size:28px;font-weight:700;color:var(--gold)}

/* History */
.history-item{background:var(--navy);border-radius:6px;padding:10px 14px;margin-bottom:6px;cursor:pointer}
.history-item:hover{background:var(--navy-light)}
.history-item .date{color:var(--gold);font-weight:600}
.history-item .meta{color:var(--text-dim);font-size:13px}

/* Profile selector */
.profile-bar{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}

/* Modal */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:100;display:none}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border-radius:10px;padding:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
.modal h3{color:var(--gold);margin-bottom:12px}
</style>
</head>
<body>
<div id="app">
<header>
  <h1>üèÅ Dyer Auto Group ‚Äî L10</h1>
  <div class="header-controls">
    <select id="profileSelect" onchange="loadProfile(this.value)"></select>
    <button class="btn btn-sm" onclick="newProfile()">+ Profile</button>
    <button class="btn-secondary btn-sm" onclick="showHistory()">üìã History</button>
    <button class="btn-secondary btn-sm" onclick="exportMeeting()">üì§ Export</button>
  </div>
</header>

<!-- Timer Bar -->
<div class="timer-bar" id="timerBar" style="display:none">
  <div>
    <div class="timer-section-name" id="timerSectionName"></div>
  </div>
  <div class="timer-display" id="timerDisplay">00:00</div>
  <div class="timer-controls">
    <button class="btn-secondary btn-sm" onclick="timerToggle()" id="timerToggleBtn">‚è∏</button>
    <button class="btn-secondary btn-sm" onclick="timerReset()">‚Ü∫</button>
    <button class="btn btn-sm" onclick="nextSection()">Next ‚Üí</button>
  </div>
</div>

<!-- Section Navigation -->
<div class="sections-nav" id="sectionsNav"></div>

<!-- SETUP -->
<div class="section-card" id="sec-setup">
  <h2>Meeting Setup</h2>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
    <div><label style="font-size:12px;color:var(--text-dim)">Meeting Name</label><input id="meetingName" style="width:100%" placeholder="e.g. Chevy Leadership L10"></div>
    <div><label style="font-size:12px;color:var(--text-dim)">Date</label><input id="meetingDate" type="date" style="width:100%"></div>
  </div>
  <div style="margin-bottom:12px">
    <label style="font-size:12px;color:var(--text-dim)">Attendees</label>
    <div class="attendees-grid" id="attendeesGrid"></div>
    <div class="add-row">
      <input id="newAttendee" placeholder="Add attendee" onkeydown="if(event.key==='Enter')addAttendee()">
      <button class="btn btn-sm" onclick="addAttendee()">+</button>
    </div>
  </div>
  <button class="btn" onclick="startMeeting()" id="startBtn" style="font-size:16px;padding:10px 30px">‚ñ∂ Start Meeting</button>
</div>

<!-- SEGUE -->
<div class="section-card" id="sec-segue">
  <h2>Segue / Good News <span class="time-alloc">5 min</span></h2>
  <p style="color:var(--text-dim);font-size:13px;margin-bottom:10px">Each attendee shares one personal + one professional good news.</p>
  <div id="segueList"></div>
</div>

<!-- SCORECARD -->
<div class="section-card" id="sec-scorecard">
  <h2>Scorecard Review <span class="time-alloc">5 min</span></h2>
  <table>
    <thead><tr><th>Metric</th><th>Owner</th><th>Goal</th><th>Actual</th><th>On Track</th></tr></thead>
    <tbody id="scorecardBody"></tbody>
  </table>
  <div class="add-row">
    <input id="scMetric" placeholder="Metric">
    <input id="scOwner" placeholder="Owner">
    <input id="scGoal" placeholder="Goal">
    <button class="btn btn-sm" onclick="addScorecard()">+ Add</button>
  </div>
</div>

<!-- ROCKS -->
<div class="section-card" id="sec-rocks">
  <h2>Rock Review <span class="time-alloc">5 min</span></h2>
  <table>
    <thead><tr><th>Rock</th><th>Owner</th><th>Status</th><th>Notes</th></tr></thead>
    <tbody id="rocksBody"></tbody>
  </table>
  <div class="add-row">
    <input id="rockName" placeholder="Rock description">
    <input id="rockOwner" placeholder="Owner">
    <button class="btn btn-sm" onclick="addRock()">+ Add</button>
  </div>
</div>

<!-- HEADLINES -->
<div class="section-card" id="sec-headlines">
  <h2>Customer/Employee Headlines <span class="time-alloc">5 min</span></h2>
  <div id="headlinesList"></div>
  <div class="add-row">
    <select id="hlType"><option>Customer</option><option>Employee</option></select>
    <input id="hlText" placeholder="Headline" style="flex:3">
    <button class="btn btn-sm" onclick="addHeadline()">+ Add</button>
  </div>
</div>

<!-- TODO REVIEW -->
<div class="section-card" id="sec-todos">
  <h2>To-Do Review <span class="time-alloc">5 min</span></h2>
  <table>
    <thead><tr><th>To-Do</th><th>Owner</th><th>Due</th><th>Status</th></tr></thead>
    <tbody id="todosBody"></tbody>
  </table>
</div>

<!-- IDS -->
<div class="section-card" id="sec-ids">
  <h2>IDS ‚Äî Identify, Discuss, Solve <span class="time-alloc">60 min</span></h2>
  <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap">
    <input id="newIssue" placeholder="Add new issue" style="flex:1" onkeydown="if(event.key==='Enter')addIssue()">
    <button class="btn btn-sm" onclick="addIssue()">+ Issue</button>
    <button class="btn-secondary btn-sm" onclick="sortIssues()">Sort by Priority</button>
  </div>
  <table>
    <thead><tr><th>Issue</th><th>Priority</th><th>Action</th></tr></thead>
    <tbody id="issuesBody"></tbody>
  </table>
  <div id="idsActive" style="display:none;margin-top:12px;background:var(--navy);border-radius:8px;padding:14px;border-left:4px solid var(--gold)">
    <h3 style="color:var(--gold);margin-bottom:8px">üîç Now IDS-ing: <span id="idsIssueName"></span></h3>
    <textarea id="idsNotes" placeholder="Discussion notes..." style="width:100%;height:60px;margin-bottom:8px"></textarea>
    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <input id="idsTodoText" placeholder="Create to-do from this..." style="flex:1">
      <input id="idsTodoOwner" placeholder="Owner" style="width:100px">
      <button class="btn btn-sm" onclick="idsMakeTodo()">‚Üí To-Do</button>
      <button class="btn-danger btn-sm" onclick="idsKill()">Kill Issue</button>
      <button class="btn-secondary btn-sm" onclick="idsDone()">Done</button>
    </div>
  </div>
</div>

<!-- CONCLUDE -->
<div class="section-card" id="sec-conclude">
  <h2>Conclude <span class="time-alloc">5 min</span></h2>
  <h3 style="font-size:14px;color:var(--text-dim);margin-bottom:8px">New To-Dos This Meeting</h3>
  <div id="newTodosRecap"></div>
  <h3 style="font-size:14px;color:var(--text-dim);margin:12px 0 8px">Rate This Meeting (1-10)</h3>
  <div id="ratingsList"></div>
  <div style="margin-top:10px;display:flex;align-items:center;gap:16px">
    <span>Average: <span class="rating-avg" id="avgRating">‚Äî</span></span>
    <div style="display:flex;gap:8px;align-items:center">
      <span style="font-size:13px;color:var(--text-dim)">Started on time?</span>
      <div class="toggle">
        <button id="onTimeYes" onclick="setOnTime(true)">Yes</button>
        <button id="onTimeNo" onclick="setOnTime(false)">No</button>
      </div>
    </div>
  </div>
  <button class="btn" onclick="endMeeting()" style="margin-top:16px;font-size:16px;padding:10px 30px">‚úÖ End Meeting & Save</button>
</div>

<!-- HISTORY -->
<div class="section-card" id="sec-history">
  <h2>Meeting History</h2>
  <div id="historyList"></div>
</div>

<!-- History Detail Modal -->
<div class="modal-overlay" id="historyModal">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 id="historyModalTitle">Meeting Details</h3>
      <button class="btn-secondary btn-sm" onclick="closeModal()">‚úï</button>
    </div>
    <pre id="historyModalContent" style="white-space:pre-wrap;font-size:13px;color:var(--text);max-height:60vh;overflow-y:auto"></pre>
  </div>
</div>
</div>

<script>
// ---- State ----
const SECTIONS = [
  {id:'setup',name:'Setup',time:0},
  {id:'segue',name:'Segue',time:300},
  {id:'scorecard',name:'Scorecard',time:300},
  {id:'rocks',name:'Rocks',time:300},
  {id:'headlines',name:'Headlines',time:300},
  {id:'todos',name:'To-Dos',time:300},
  {id:'ids',name:'IDS',time:3600},
  {id:'conclude',name:'Conclude',time:300}
];

let state = {
  profileId: null,
  meetingActive: false,
  currentSection: 0,
  meetingName: '',
  meetingDate: '',
  startTime: '',
  attendees: [],
  onTime: null,
  segue: {},
  scorecard: [],
  rocks: [],
  headlines: [],
  todos: [],
  issues: [],
  newTodos: [],
  ratings: {},
  idsActiveIdx: null
};

let timerInterval = null;
let timerSeconds = 0;
let timerRunning = false;

// ---- Profiles ----
function getProfiles() {
  return JSON.parse(localStorage.getItem('l10_profiles') || '{}');
}
function saveProfiles(p) { localStorage.setItem('l10_profiles', JSON.stringify(p)); }

function loadProfileList() {
  const sel = document.getElementById('profileSelect');
  const profiles = getProfiles();
  sel.innerHTML = '';
  const ids = Object.keys(profiles);
  if (ids.length === 0) { newProfile(); return; }
  ids.forEach(id => {
    const o = document.createElement('option');
    o.value = id; o.textContent = profiles[id].name;
    sel.appendChild(o);
  });
  if (state.profileId && profiles[state.profileId]) sel.value = state.profileId;
  else loadProfile(ids[0]);
}

function newProfile() {
  const name = prompt('Meeting profile name (e.g., "Chevy Leadership L10"):');
  if (!name) return;
  const id = 'p_' + Date.now();
  const profiles = getProfiles();
  const defaultAttendees = ['Jeff Blaney'];
  const defaultScorecard = [
    {metric:'Units Sold',owner:'',goal:'',actual:'',onTrack:null},
    {metric:'Gross/Unit',owner:'',goal:'',actual:'',onTrack:null},
    {metric:'CSI Score',owner:'',goal:'',actual:'',onTrack:null},
    {metric:'Service ROs',owner:'',goal:'',actual:'',onTrack:null},
    {metric:'Appt Show Rate',owner:'',goal:'',actual:'',onTrack:null},
    {metric:'Website Leads',owner:'',goal:'',actual:'',onTrack:null},
    {metric:'Close Ratio',owner:'',goal:'',actual:'',onTrack:null},
    {metric:'Avg Days to Sell',owner:'',goal:'',actual:'',onTrack:null}
  ];
  profiles[id] = { name, attendees: defaultAttendees, scorecard: defaultScorecard, rocks: [], issues: [], todos: [] };
  saveProfiles(profiles);
  state.profileId = id;
  loadProfileList();
  loadProfile(id);
}

function loadProfile(id) {
  const profiles = getProfiles();
  if (!profiles[id]) return;
  const p = profiles[id];
  state.profileId = id;
  state.meetingActive = false;
  state.currentSection = 0;
  state.attendees = [...p.attendees];
  state.scorecard = JSON.parse(JSON.stringify(p.scorecard));
  state.rocks = JSON.parse(JSON.stringify(p.rocks || []));
  state.issues = JSON.parse(JSON.stringify(p.issues || []));
  state.todos = JSON.parse(JSON.stringify(p.todos || []));
  state.headlines = [];
  state.newTodos = [];
  state.segue = {};
  state.ratings = {};
  state.onTime = null;
  state.idsActiveIdx = null;
  state.meetingName = p.name;
  document.getElementById('meetingName').value = p.name;
  document.getElementById('meetingDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('profileSelect').value = id;
  stopTimer();
  document.getElementById('timerBar').style.display = 'none';
  showSection(0);
  renderAll();
}

function saveProfileData() {
  const profiles = getProfiles();
  if (!profiles[state.profileId]) return;
  profiles[state.profileId].attendees = [...state.attendees];
  profiles[state.profileId].scorecard = state.scorecard.map(s => ({metric:s.metric,owner:s.owner,goal:s.goal,actual:'',onTrack:null}));
  profiles[state.profileId].rocks = state.rocks.map(r => ({name:r.name,owner:r.owner,onTrack:r.onTrack,notes:''}));
  profiles[state.profileId].issues = state.issues.filter(i => !i.killed);
  profiles[state.profileId].todos = state.todos.filter(t => !t.done);
  saveProfiles(profiles);
}

// ---- Navigation ----
function buildNav() {
  const nav = document.getElementById('sectionsNav');
  nav.innerHTML = '';
  SECTIONS.forEach((s, i) => {
    const b = document.createElement('button');
    b.textContent = s.name;
    b.onclick = () => goToSection(i);
    b.id = 'nav-' + i;
    nav.appendChild(b);
  });
  // History tab
  const hb = document.createElement('button');
  hb.textContent = 'üìã History';
  hb.onclick = () => showHistory();
  hb.id = 'nav-history';
  nav.appendChild(hb);
}

function showSection(idx) {
  SECTIONS.forEach((s, i) => {
    document.getElementById('sec-' + s.id).classList.toggle('active', i === idx);
    const nb = document.getElementById('nav-' + i);
    if (nb) nb.classList.toggle('active', i === idx);
  });
  document.getElementById('sec-history').classList.remove('active');
  const hb = document.getElementById('nav-history');
  if (hb) hb.classList.remove('active');
  state.currentSection = idx;
}

function goToSection(idx) {
  showSection(idx);
  if (state.meetingActive && idx > 0) {
    startSectionTimer(idx);
  }
}

function nextSection() {
  const next = state.currentSection + 1;
  if (next < SECTIONS.length) {
    document.getElementById('nav-' + state.currentSection).classList.add('completed');
    goToSection(next);
    if (next === SECTIONS.length - 1) renderConclude();
  }
}

function showHistory() {
  SECTIONS.forEach((s, i) => {
    document.getElementById('sec-' + s.id).classList.remove('active');
    const nb = document.getElementById('nav-' + i);
    if (nb) nb.classList.remove('active');
  });
  document.getElementById('sec-history').classList.add('active');
  const hb = document.getElementById('nav-history');
  if (hb) hb.classList.add('active');
  renderHistory();
}

// ---- Timer ----
function startSectionTimer(idx) {
  const sec = SECTIONS[idx];
  if (!sec || sec.time === 0) { document.getElementById('timerBar').style.display = 'none'; return; }
  document.getElementById('timerBar').style.display = 'flex';
  document.getElementById('timerSectionName').textContent = sec.name;
  timerSeconds = sec.time;
  timerRunning = true;
  document.getElementById('timerToggleBtn').textContent = '‚è∏';
  updateTimerDisplay();
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    if (!timerRunning) return;
    timerSeconds--;
    updateTimerDisplay();
  }, 1000);
}

function updateTimerDisplay() {
  const el = document.getElementById('timerDisplay');
  const abs = Math.abs(timerSeconds);
  const m = Math.floor(abs / 60);
  const s = abs % 60;
  const sign = timerSeconds < 0 ? '-' : '';
  el.textContent = sign + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
  el.className = 'timer-display';
  if (timerSeconds <= 0) el.classList.add('expired');
  else if (timerSeconds <= 60) el.classList.add('warning');
}

function timerToggle() {
  timerRunning = !timerRunning;
  document.getElementById('timerToggleBtn').textContent = timerRunning ? '‚è∏' : '‚ñ∂';
}

function timerReset() {
  const sec = SECTIONS[state.currentSection];
  if (sec) { timerSeconds = sec.time; updateTimerDisplay(); }
}

function stopTimer() {
  clearInterval(timerInterval);
  timerRunning = false;
}

// ---- Meeting Flow ----
function startMeeting() {
  state.meetingActive = true;
  state.meetingName = document.getElementById('meetingName').value || 'L10 Meeting';
  state.meetingDate = document.getElementById('meetingDate').value;
  state.startTime = new Date().toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit'});
  goToSection(1);
  startSectionTimer(1);
  renderSegue();
}

// ---- Attendees ----
function renderAttendees() {
  const g = document.getElementById('attendeesGrid');
  g.innerHTML = '';
  state.attendees.forEach((a, i) => {
    const d = document.createElement('div');
    d.className = 'attendee-chip';
    d.innerHTML = `${a} <span class="remove" onclick="removeAttendee(${i})">‚úï</span>`;
    g.appendChild(d);
  });
}

function addAttendee() {
  const inp = document.getElementById('newAttendee');
  const name = inp.value.trim();
  if (!name) return;
  state.attendees.push(name);
  inp.value = '';
  renderAttendees();
  saveProfileData();
}

function removeAttendee(i) {
  state.attendees.splice(i, 1);
  renderAttendees();
  saveProfileData();
}

// ---- Segue ----
function renderSegue() {
  const el = document.getElementById('segueList');
  el.innerHTML = '';
  state.attendees.forEach(a => {
    if (!state.segue[a]) state.segue[a] = {personal:'',professional:''};
    el.innerHTML += `<div style="margin-bottom:8px;padding:8px;background:var(--navy);border-radius:6px">
      <strong>${a}</strong>
      <div style="display:flex;gap:6px;margin-top:4px">
        <input placeholder="Personal good news" value="${state.segue[a].personal}" onchange="state.segue['${a}'].personal=this.value" style="flex:1">
        <input placeholder="Professional good news" value="${state.segue[a].professional}" onchange="state.segue['${a}'].professional=this.value" style="flex:1">
      </div>
    </div>`;
  });
}

// ---- Scorecard ----
function renderScorecard() {
  const tb = document.getElementById('scorecardBody');
  tb.innerHTML = '';
  state.scorecard.forEach((s, i) => {
    const onClass = s.onTrack === true ? 'on' : '';
    const offClass = s.onTrack === false ? 'off' : '';
    tb.innerHTML += `<tr>
      <td>${s.metric}</td>
      <td><input value="${s.owner}" onchange="state.scorecard[${i}].owner=this.value" style="width:100px"></td>
      <td><input value="${s.goal}" onchange="state.scorecard[${i}].goal=this.value" style="width:80px"></td>
      <td><input value="${s.actual}" onchange="state.scorecard[${i}].actual=this.value" style="width:80px"></td>
      <td><div class="toggle">
        <button class="${onClass}" onclick="state.scorecard[${i}].onTrack=true;renderScorecard()">‚úì</button>
        <button class="${offClass}" onclick="state.scorecard[${i}].onTrack=false;renderScorecard()">‚úó</button>
      </div></td>
    </tr>`;
  });
}

function addScorecard() {
  const m = document.getElementById('scMetric').value.trim();
  if (!m) return;
  state.scorecard.push({metric:m,owner:document.getElementById('scOwner').value.trim(),goal:document.getElementById('scGoal').value.trim(),actual:'',onTrack:null});
  document.getElementById('scMetric').value = '';
  document.getElementById('scOwner').value = '';
  document.getElementById('scGoal').value = '';
  renderScorecard();
}

// ---- Rocks ----
function renderRocks() {
  const tb = document.getElementById('rocksBody');
  tb.innerHTML = '';
  state.rocks.forEach((r, i) => {
    const onClass = r.onTrack === true ? 'on' : '';
    const offClass = r.onTrack === false ? 'off' : '';
    tb.innerHTML += `<tr>
      <td>${r.name}</td>
      <td>${r.owner}</td>
      <td><div class="toggle">
        <button class="${onClass}" onclick="state.rocks[${i}].onTrack=true;renderRocks()">On Track</button>
        <button class="${offClass}" onclick="state.rocks[${i}].onTrack=false;renderRocks()">Off Track</button>
      </div></td>
      <td><input value="${r.notes||''}" onchange="state.rocks[${i}].notes=this.value" placeholder="Notes" style="width:150px"></td>
    </tr>`;
  });
}

function addRock() {
  const n = document.getElementById('rockName').value.trim();
  if (!n) return;
  state.rocks.push({name:n,owner:document.getElementById('rockOwner').value.trim(),onTrack:null,notes:''});
  document.getElementById('rockName').value = '';
  document.getElementById('rockOwner').value = '';
  renderRocks();
}

// ---- Headlines ----
function renderHeadlines() {
  const el = document.getElementById('headlinesList');
  el.innerHTML = '';
  state.headlines.forEach((h, i) => {
    el.innerHTML += `<div style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid #2a3a5a">
      <span style="font-size:11px;color:var(--gold);min-width:70px">${h.type}</span>
      <span style="flex:1">${h.text}</span>
      <button class="btn-danger btn-sm" onclick="state.headlines.splice(${i},1);renderHeadlines()">‚úï</button>
    </div>`;
  });
}

function addHeadline() {
  const text = document.getElementById('hlText').value.trim();
  if (!text) return;
  state.headlines.push({type:document.getElementById('hlType').value,text});
  document.getElementById('hlText').value = '';
  renderHeadlines();
}

// ---- Todos ----
function renderTodos() {
  const tb = document.getElementById('todosBody');
  tb.innerHTML = '';
  state.todos.forEach((t, i) => {
    const doneClass = t.done ? 'on' : '';
    const notClass = !t.done && t.done !== undefined ? 'off' : '';
    tb.innerHTML += `<tr style="${t.done ? 'opacity:.5' : ''}">
      <td>${t.text}</td>
      <td>${t.owner}</td>
      <td>${t.due || '‚Äî'}</td>
      <td><div class="toggle">
        <button class="${doneClass}" onclick="state.todos[${i}].done=true;renderTodos()">Done</button>
        <button class="${notClass}" onclick="state.todos[${i}].done=false;renderTodos()">Not Done</button>
      </div></td>
    </tr>`;
  });
}

// ---- IDS ----
function renderIssues() {
  const tb = document.getElementById('issuesBody');
  tb.innerHTML = '';
  state.issues.forEach((issue, i) => {
    if (issue.killed) return;
    tb.innerHTML += `<tr>
      <td>${issue.text}</td>
      <td><select onchange="state.issues[${i}].priority=+this.value" style="width:60px">
        <option value="0" ${issue.priority===0?'selected':''}>‚Äî</option>
        <option value="1" ${issue.priority===1?'selected':''}>1</option>
        <option value="2" ${issue.priority===2?'selected':''}>2</option>
        <option value="3" ${issue.priority===3?'selected':''}>3</option>
      </select></td>
      <td><button class="btn btn-sm" onclick="idsStart(${i})">IDS</button></td>
    </tr>`;
  });
}

function addIssue() {
  const text = document.getElementById('newIssue').value.trim();
  if (!text) return;
  state.issues.push({text,priority:0,killed:false});
  document.getElementById('newIssue').value = '';
  renderIssues();
}

function sortIssues() {
  state.issues.sort((a, b) => (b.priority || 0) - (a.priority || 0));
  renderIssues();
}

function idsStart(i) {
  state.idsActiveIdx = i;
  document.getElementById('idsActive').style.display = 'block';
  document.getElementById('idsIssueName').textContent = state.issues[i].text;
  document.getElementById('idsNotes').value = '';
  document.getElementById('idsTodoText').value = '';
  document.getElementById('idsTodoOwner').value = '';
}

function idsMakeTodo() {
  const text = document.getElementById('idsTodoText').value.trim();
  const owner = document.getElementById('idsTodoOwner').value.trim();
  if (!text) return;
  const todo = {text,owner,due:'',done:false,newThisMeeting:true};
  state.todos.push(todo);
  state.newTodos.push(todo);
  document.getElementById('idsTodoText').value = '';
  document.getElementById('idsTodoOwner').value = '';
  alert('To-do created: ' + text);
}

function idsKill() {
  if (state.idsActiveIdx !== null) {
    state.issues[state.idsActiveIdx].killed = true;
    idsDone();
  }
}

function idsDone() {
  state.idsActiveIdx = null;
  document.getElementById('idsActive').style.display = 'none';
  renderIssues();
}

// ---- Conclude ----
function renderConclude() {
  const el = document.getElementById('newTodosRecap');
  if (state.newTodos.length === 0) {
    el.innerHTML = '<p style="color:var(--text-dim)">No new to-dos this meeting.</p>';
  } else {
    el.innerHTML = state.newTodos.map(t => `<div style="padding:4px 0;border-bottom:1px solid #2a3a5a">‚Ä¢ ${t.text} <span style="color:var(--text-dim)">(${t.owner || 'unassigned'})</span></div>`).join('');
  }
  const rl = document.getElementById('ratingsList');
  rl.innerHTML = '';
  state.attendees.forEach(a => {
    if (state.ratings[a] === undefined) state.ratings[a] = 8;
    rl.innerHTML += `<div class="rating-row">
      <span style="min-width:100px">${a}</span>
      <input type="range" min="1" max="10" value="${state.ratings[a]}" oninput="state.ratings['${a}']=+this.value;calcAvg();document.getElementById('val_${a.replace(/\s/g,'_')}').textContent=this.value">
      <span id="val_${a.replace(/\s/g,'_')}" style="min-width:20px;text-align:center">${state.ratings[a]}</span>
    </div>`;
  });
  calcAvg();
}

function calcAvg() {
  const vals = Object.values(state.ratings);
  if (vals.length === 0) return;
  const avg = (vals.reduce((a,b) => a+b, 0) / vals.length).toFixed(1);
  document.getElementById('avgRating').textContent = avg;
}

function setOnTime(v) {
  state.onTime = v;
  document.getElementById('onTimeYes').className = v ? 'on' : '';
  document.getElementById('onTimeNo').className = !v ? 'off' : '';
}

// ---- End Meeting ----
function endMeeting() {
  stopTimer();
  const meeting = {
    id: 'm_' + Date.now(),
    profileId: state.profileId,
    name: state.meetingName,
    date: state.meetingDate,
    startTime: state.startTime,
    endTime: new Date().toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit'}),
    attendees: [...state.attendees],
    onTime: state.onTime,
    segue: {...state.segue},
    scorecard: JSON.parse(JSON.stringify(state.scorecard)),
    rocks: JSON.parse(JSON.stringify(state.rocks)),
    headlines: [...state.headlines],
    todos: JSON.parse(JSON.stringify(state.todos)),
    newTodos: [...state.newTodos],
    issues: state.issues.filter(i => !i.killed),
    ratings: {...state.ratings},
    avgRating: document.getElementById('avgRating').textContent
  };
  const history = JSON.parse(localStorage.getItem('l10_history') || '[]');
  history.unshift(meeting);
  localStorage.setItem('l10_history', JSON.stringify(history));
  saveProfileData();
  state.meetingActive = false;
  document.getElementById('timerBar').style.display = 'none';
  alert('Meeting saved! ‚úÖ');
  showSection(0);
}

// ---- History ----
function renderHistory() {
  const history = JSON.parse(localStorage.getItem('l10_history') || '[]');
  const el = document.getElementById('historyList');
  if (history.length === 0) { el.innerHTML = '<p style="color:var(--text-dim)">No past meetings.</p>'; return; }
  el.innerHTML = history.map((m, i) => `<div class="history-item" onclick="viewMeeting(${i})">
    <span class="date">${m.date}</span> ‚Äî ${m.name}
    <div class="meta">${m.startTime} ‚Üí ${m.endTime} | Rating: ${m.avgRating} | ${m.attendees?.length || 0} attendees</div>
  </div>`).join('');
}

function viewMeeting(i) {
  const history = JSON.parse(localStorage.getItem('l10_history') || '[]');
  const m = history[i];
  if (!m) return;
  document.getElementById('historyModalTitle').textContent = m.name + ' ‚Äî ' + m.date;
  document.getElementById('historyModalContent').textContent = formatMeetingText(m);
  document.getElementById('historyModal').classList.add('show');
}

function closeModal() { document.getElementById('historyModal').classList.remove('show'); }

// ---- Export ----
function formatMeetingText(m) {
  if (!m) m = {
    name:state.meetingName,date:state.meetingDate,startTime:state.startTime,
    endTime:'',attendees:state.attendees,onTime:state.onTime,segue:state.segue,
    scorecard:state.scorecard,rocks:state.rocks,headlines:state.headlines,
    todos:state.todos,newTodos:state.newTodos,issues:state.issues,ratings:state.ratings,
    avgRating:document.getElementById('avgRating')?.textContent||'‚Äî'
  };
  let t = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
  t += `  ${m.name}\n  ${m.date} | ${m.startTime} ‚Üí ${m.endTime || 'ongoing'}\n`;
  t += `  Started on time: ${m.onTime===true?'Yes':m.onTime===false?'No':'N/A'}\n`;
  t += `  Attendees: ${(m.attendees||[]).join(', ')}\n`;
  t += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;

  t += `‚îÄ‚îÄ SEGUE / GOOD NEWS ‚îÄ‚îÄ\n`;
  Object.entries(m.segue||{}).forEach(([name,v]) => {
    t += `  ${name}: Personal: ${v.personal||'‚Äî'} | Professional: ${v.professional||'‚Äî'}\n`;
  });

  t += `\n‚îÄ‚îÄ SCORECARD ‚îÄ‚îÄ\n`;
  (m.scorecard||[]).forEach(s => {
    const status = s.onTrack===true?'‚úì':s.onTrack===false?'‚úó':'‚Äî';
    t += `  ${s.metric}: Goal=${s.goal||'‚Äî'} Actual=${s.actual||'‚Äî'} [${status}] (${s.owner||'‚Äî'})\n`;
  });

  t += `\n‚îÄ‚îÄ ROCKS ‚îÄ‚îÄ\n`;
  (m.rocks||[]).forEach(r => {
    t += `  ${r.name} (${r.owner||'‚Äî'}): ${r.onTrack===true?'On Track':r.onTrack===false?'Off Track':'‚Äî'} ${r.notes?'| '+r.notes:''}\n`;
  });

  t += `\n‚îÄ‚îÄ HEADLINES ‚îÄ‚îÄ\n`;
  (m.headlines||[]).forEach(h => { t += `  [${h.type}] ${h.text}\n`; });

  t += `\n‚îÄ‚îÄ TO-DOS ‚îÄ‚îÄ\n`;
  (m.todos||[]).forEach(td => {
    t += `  ${td.done?'‚úì':'‚óã'} ${td.text} (${td.owner||'‚Äî'})\n`;
  });

  t += `\n‚îÄ‚îÄ NEW TO-DOS THIS MEETING ‚îÄ‚îÄ\n`;
  (m.newTodos||[]).forEach(td => { t += `  ‚Üí ${td.text} (${td.owner||'‚Äî'})\n`; });

  t += `\n‚îÄ‚îÄ ISSUES (Open) ‚îÄ‚îÄ\n`;
  (m.issues||[]).filter(i=>!i.killed).forEach(i => { t += `  ‚Ä¢ ${i.text} [Priority: ${i.priority||'‚Äî'}]\n`; });

  t += `\n‚îÄ‚îÄ RATING ‚îÄ‚îÄ\n`;
  Object.entries(m.ratings||{}).forEach(([name,v]) => { t += `  ${name}: ${v}/10\n`; });
  t += `  Average: ${m.avgRating}\n`;

  return t;
}

function exportMeeting() {
  const text = formatMeetingText(null);
  navigator.clipboard.writeText(text).then(() => alert('Meeting notes copied to clipboard! üìã')).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    alert('Meeting notes copied to clipboard! üìã');
  });
}

// ---- Render All ----
function renderAll() {
  renderAttendees();
  renderScorecard();
  renderRocks();
  renderHeadlines();
  renderTodos();
  renderIssues();
}

// ---- Init ----
buildNav();
loadProfileList();
showSection(0);
</script>
</body>
</html>
