<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Command Center — Kit's War Room</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<style>
:root {
  --bg: #0D1117;
  --card: #161B22;
  --border: #2D333B;
  --accent: #2B4C7E;
  --text: #E6EDF3;
  --text-secondary: #8B949E;
  --text-muted: #6B7280;
  --text-body: #C9D1D9;
  --green: #10B981;
  --blue: #3B82F6;
  --red: #EF4444;
  --time-blue: #5B8FD4;
  --radius: 12px;
  --font: 'Inter', -apple-system, sans-serif;
  --mono: 'JetBrains Mono', monospace;
}
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  min-height: 100vh;
  background-image: radial-gradient(rgba(255,255,255,.015) 1px, transparent 1px);
  background-size: 24px 24px;
}

/* Header */
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 28px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(13,17,23,.95), rgba(13,17,23,1));
  position: sticky; top: 0; z-index: 10;
  backdrop-filter: blur(12px);
}
.header::after {
  content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
}
.header-left { display: flex; align-items: center; gap: 16px; }
.header-title { font-size: 20px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; }
.live-badge {
  display: flex; align-items: center; gap: 6px;
  background: rgba(16,185,129,.08); border: 1px solid rgba(16,185,129,.2);
  border-radius: 20px; padding: 4px 12px 4px 8px; font-size: 13px; font-weight: 500; color: var(--green);
}
.live-dot {
  width: 8px; height: 8px; border-radius: 50%; background: var(--green);
  animation: pulse 2s ease-in-out infinite;
}
.offline .live-dot { background: var(--red); animation: none; }
.offline .live-badge { color: var(--red); background: rgba(239,68,68,.08); border-color: rgba(239,68,68,.2); }
.clock { font-family: var(--mono); font-size: 15px; color: var(--text-secondary); font-weight: 600; }

@keyframes pulse {
  0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16,185,129,.4); }
  50% { opacity: .7; box-shadow: 0 0 0 6px rgba(16,185,129,0); }
}

/* Layout */
.layout {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 0;
  min-height: calc(100vh - 57px);
}
.main { padding: 24px 28px; overflow-y: auto; }

/* Stats */
.stats-grid {
  display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 28px;
}
.stat-card {
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 16px 18px; transition: all .2s ease; cursor: default;
}
.stat-card:hover { transform: translateY(-2px); border-color: var(--accent); box-shadow: 0 4px 20px rgba(43,76,126,.15); }
.stat-value { font-family: var(--mono); font-size: 28px; font-weight: 700; color: var(--text); line-height: 1.2; }
.stat-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .8px; color: var(--text-secondary); margin-top: 4px; }

/* Agents */
.agents-grid {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px;
}
.agent-card {
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 20px; display: flex; flex-direction: column; gap: 6px;
  transition: all .25s ease; cursor: default; min-height: 180px; position: relative;
}
.agent-card:hover { border-color: var(--accent); box-shadow: 0 4px 24px rgba(43,76,126,.12); }
.agent-card.pulse-green { animation: cardPulse .6s ease; }
@keyframes cardPulse {
  0% { border-color: var(--border); }
  50% { border-color: var(--green); box-shadow: 0 0 20px rgba(16,185,129,.15); }
  100% { border-color: var(--border); }
}
.agent-emoji { font-size: 28px; line-height: 1; }
.agent-name { font-size: 16px; font-weight: 600; color: var(--text); }
.agent-role { font-size: 12px; color: var(--text-secondary); }
.agent-model { font-family: var(--mono); font-size: 10px; color: var(--text-muted); margin-top: 2px; }
.agent-task { font-size: 13px; color: var(--text-body); margin-top: auto; line-height: 1.4;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.agent-status {
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px;
  padding: 4px 10px; border-radius: 6px; width: fit-content; margin-top: 8px;
}
.status-working { color: var(--green); background: rgba(16,185,129,.1); }
.status-working .status-dot { background: var(--green); animation: pulse 2s ease-in-out infinite; }
.status-complete { color: var(--blue); background: rgba(59,130,246,.1); }
.status-idle { color: var(--text-muted); background: rgba(107,114,128,.1); }
.status-error { color: var(--red); background: rgba(239,68,68,.1); }
.status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; flex-shrink: 0; }

/* Activity Feed */
.activity {
  border-left: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column;
  max-height: calc(100vh - 57px); position: sticky; top: 57px;
}
.activity-header {
  display: flex; align-items: center; gap: 8px;
  font-size: 14px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;
  letter-spacing: .8px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);
}
.activity-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0; }
.activity-list::-webkit-scrollbar { width: 4px; }
.activity-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
.activity-item {
  padding: 10px 0; border-bottom: 1px solid rgba(45,51,59,.5);
  animation: slideIn .3s ease;
}
@keyframes slideIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
.activity-time { font-family: var(--mono); font-size: 12px; color: var(--time-blue); margin-bottom: 3px; }
.activity-text { font-size: 13px; color: var(--text-body); line-height: 1.4; margin-bottom: 4px; }
.activity-agent {
  display: inline-block; font-size: 10px; font-weight: 600; color: var(--accent);
  background: rgba(43,76,126,.15); border-radius: 4px; padding: 1px 6px; letter-spacing: .3px;
}

/* Comms Lines */
.agents-wrapper { position: relative; }
.comms-svg {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 1;
}
.comms-line {
  stroke: var(--green); stroke-width: 2; fill: none;
  stroke-dasharray: 8 4; animation: dashFlow 1s linear infinite;
}
.comms-line.inactive { stroke: var(--text-muted); stroke-width: 1; opacity: .4; animation: none; }
@keyframes dashFlow { to { stroke-dashoffset: -12; } }
.comms-dot {
  fill: var(--green); r: 4;
}
.comms-dot.inactive { fill: var(--text-muted); opacity: .4; }
.comms-label {
  font-family: var(--mono); font-size: 9px; fill: var(--text-secondary);
  text-anchor: middle; dominant-baseline: middle;
}
.agent-card { position: relative; z-index: 2; }

/* Connecting state */
.connecting { text-align: center; padding: 60px 20px; color: var(--text-secondary); font-size: 15px; }
.connecting-spinner { width: 24px; height: 24px; border: 2px solid var(--border); border-top-color: var(--accent);
  border-radius: 50%; animation: spin .8s linear infinite; margin: 0 auto 12px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Mobile */
@media (max-width: 768px) {
  .layout { grid-template-columns: 1fr; }
  .activity { border-left: none; border-top: 1px solid var(--border); position: static; max-height: none; }
  .stats-grid { grid-template-columns: repeat(3, 1fr); }
  .agents-grid { grid-template-columns: repeat(2, 1fr); }
  .main { padding: 16px; }
}
@media (max-width: 640px) {
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .agents-grid { grid-template-columns: repeat(2, 1fr); }
  .header { padding: 12px 16px; }
  .header-title { font-size: 16px; letter-spacing: 1px; }
  .stat-value { font-size: 22px; }
  .agent-card { min-height: 160px; padding: 16px; }
}
</style>
</head>
<body>
<div class="header" id="header">
  <div class="header-left">
    <span class="header-title">Command Center</span>
    <div class="live-badge"><span class="live-dot"></span><span id="liveText">Live</span></div>
  </div>
  <span class="clock" id="clock"></span>
</div>

<div class="layout">
  <div class="main" id="main">
    <div class="connecting" id="connecting"><div class="connecting-spinner"></div>Connecting...</div>
  </div>
  <div class="activity" id="activityPanel" style="display:none">
    <div class="activity-header"><i data-lucide="activity" style="width:16px;height:16px"></i> Activity Feed</div>
    <div class="activity-list" id="activityList"></div>
  </div>
</div>

<script>
const API = '/api/status';
const KEY = '689b1f85c91ffc61ef7469ea7b4c75f796a7025848bb3c7c';
let prevStatuses = {};
let initialized = false;

// Clock
function updateClock() {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}
updateClock();
setInterval(updateClock, 1000);

// Count-up animation
function animateValue(el, end, duration, format) {
  const start = 0;
  const startTime = performance.now();
  function step(now) {
    const progress = Math.min((now - startTime) / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3);
    const current = Math.round(start + (end - start) * eased);
    el.textContent = format ? format(current) : current.toLocaleString();
    if (progress < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

function formatUptime(seconds) {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}

function renderStats(stats) {
  const items = [
    { label: 'Lines of Code', value: stats.linesOfCode, key: 'loc' },
    { label: 'Files', value: stats.files, key: 'files' },
    { label: 'Screens', value: stats.screens, key: 'screens' },
    { label: 'Components', value: stats.components, key: 'comps' },
    { label: 'Commits', value: stats.commits, key: 'commits' },
    { label: 'Uptime', value: stats.uptime, key: 'uptime', format: formatUptime },
  ];
  return `<div class="stats-grid">${items.map((s, i) =>
    `<div class="stat-card"><div class="stat-value" data-key="${s.key}" data-target="${s.value}" data-delay="${i * 100}" data-format="${s.key === 'uptime' ? 'uptime' : ''}">${s.format ? s.format(s.value) : s.value.toLocaleString()}</div><div class="stat-label">${s.label}</div></div>`
  ).join('')}</div>`;
}

function statusClass(s) {
  return ({ working: 'status-working', complete: 'status-complete', idle: 'status-idle', error: 'status-error' })[s] || 'status-idle';
}
function statusLabel(s) {
  return ({ working: 'Working', complete: 'Complete', idle: 'Idle', error: 'Error' })[s] || 'Idle';
}
function statusIcon(s) {
  if (s === 'complete') return '✓';
  return `<span class="status-dot"></span>`;
}

function renderAgents(agents) {
  return `<div class="agents-wrapper"><svg class="comms-svg" id="commsSvg"></svg><div class="agents-grid">${agents.map(a => {
    const changed = prevStatuses[a.name] && prevStatuses[a.name] !== a.status;
    return `<div class="agent-card${changed ? ' pulse-green' : ''}" data-agent="${a.name.toLowerCase()}">
      <div class="agent-emoji">${a.emoji}</div>
      <div class="agent-name">${a.name}</div>
      <div class="agent-role">${a.role}</div>
      <div class="agent-model">${a.model}</div>
      <div class="agent-task">${a.task}</div>
      <div class="agent-status ${statusClass(a.status)}">${statusIcon(a.status)} ${statusLabel(a.status)}</div>
    </div>`;
  }).join('')}</div></div>`;
}

function renderCommsLines(links) {
  if (!links || !links.length) { const svg = document.getElementById('commsSvg'); if(svg) svg.innerHTML = ''; return; }
  requestAnimationFrame(() => {
    const svg = document.getElementById('commsSvg');
    if (!svg) return;
    const wrapper = svg.parentElement;
    const wRect = wrapper.getBoundingClientRect();
    svg.setAttribute('viewBox', `0 0 ${wRect.width} ${wRect.height}`);
    svg.style.width = wRect.width + 'px';
    svg.style.height = wRect.height + 'px';
    let html = '<defs><marker id="arrowG" markerWidth="6" markerHeight="4" refX="6" refY="2" orient="auto"><polygon points="0 0, 6 2, 0 4" fill="#10B981"/></marker><marker id="arrowM" markerWidth="6" markerHeight="4" refX="6" refY="2" orient="auto"><polygon points="0 0, 6 2, 0 4" fill="#6B7280"/></marker></defs>';
    for (const link of links) {
      const fromEl = wrapper.querySelector(`[data-agent="${link.from}"]`);
      const toEl = wrapper.querySelector(`[data-agent="${link.to}"]`);
      if (!fromEl || !toEl) continue;
      const fR = fromEl.getBoundingClientRect();
      const tR = toEl.getBoundingClientRect();
      const fx = fR.left + fR.width/2 - wRect.left;
      const fy = fR.top + fR.height/2 - wRect.top;
      const tx = tR.left + tR.width/2 - wRect.left;
      const ty = tR.top + tR.height/2 - wRect.top;
      const cls = link.active ? 'comms-line' : 'comms-line inactive';
      const marker = link.active ? 'url(#arrowG)' : 'url(#arrowM)';
      // Curved line
      const mx = (fx+tx)/2, my = (fy+ty)/2 - 30;
      html += `<path class="${cls}" d="M${fx},${fy} Q${mx},${my} ${tx},${ty}" marker-end="${marker}"/>`;
      if (link.label) {
        const lx = (fx+tx)/2, ly = (fy+ty)/2 - 18;
        html += `<text class="comms-label" x="${lx}" y="${ly}">${link.label.substring(0,20)}</text>`;
      }
    }
    svg.innerHTML = html;
  });
}

function renderActivity(items) {
  return items.map(a =>
    `<div class="activity-item">
      <div class="activity-time">${a.time}</div>
      <div class="activity-text">${a.text}</div>
      <span class="activity-agent">${a.agent}</span>
    </div>`
  ).join('');
}

async function fetchData() {
  try {
    const res = await fetch(API, { headers: { 'X-API-Key': KEY } });
    if (!res.ok) throw new Error(res.status);
    const data = await res.json();

    document.getElementById('header').classList.remove('offline');
    document.getElementById('liveText').textContent = 'Live';

    const main = document.getElementById('main');
    const isFirst = !initialized;
    main.innerHTML = renderStats(data.stats) + renderAgents(data.agents);
    renderCommsLines(data.commsLinks || []);

    if (isFirst) {
      // Animate stats on first load
      main.querySelectorAll('.stat-value[data-target]').forEach(el => {
        const target = parseInt(el.dataset.target);
        const delay = parseInt(el.dataset.delay);
        const fmt = el.dataset.format;
        setTimeout(() => {
          animateValue(el, target, 600, fmt === 'uptime' ? formatUptime : null);
        }, delay);
      });
      initialized = true;
    }

    // Track status changes
    data.agents.forEach(a => { prevStatuses[a.name] = a.status; });

    // Activity
    const panel = document.getElementById('activityPanel');
    panel.style.display = '';
    document.getElementById('activityList').innerHTML = renderActivity(data.activity);

    lucide.createIcons();
  } catch (e) {
    document.getElementById('header').classList.add('offline');
    document.getElementById('liveText').textContent = 'Offline';
  }
}

fetchData();
setInterval(fetchData, 5000);
</script>
</body>
</html>
